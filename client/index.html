<!DOCTYPE html>
<html>
  <head>
    <title>wren</title>
    <script src="../bower_components/jquery/jquery.min.js"></script>
    <script src="../bower_components/moment/min/moment.min.js"></script>
    <script src="../bower_components/Chart.js/Chart.min.js"></script>
    <script src="../bower_components/highstock/js/highstock.src.js"></script>
    <script src="../bower_components/underscore/underscore-min.js"></script>
    <script src="../bower_components/backbone/backbone-min.js"></script>

    <!-- Backbone files -->
    <script src="app/models/App.js"></script>

    <script src="app/views/AppView.js"></script>
    
    <link rel="stylesheet" type="text/css" href="style/style.css">
    <script src="style/Highcharts.theme.js"></script>
  </head>
  <body>
    <script>
      $(document).ready(function() {
        // Initialize Backbone App here
        // set up model objects
        var app = new App({});

        // build a view for the top level of the whole app
        var appView = new AppView({model: app});

        // Clicking refresh button sends GET request to '/data'
        $('button.refresh').click(function() {
          var startingTime = new Date() - (1800000 * 24);
          var timeDeltas = [];

          // create labels for chart
          for (var i = 0; i < 24; i++) {
            timeDeltas[i] = startingTime;
            startingTime += 1800000;
          }

          // $.get('http://little-wren.herokuapp.com/data', moment(timeDeltas[0]).format('YYYY-MM-DD HH:mm:ss'),function(data){
          $.get('http://127.0.0.1:5000/data', moment(timeDeltas[0]).format('YYYY-MM-DD HH:mm:ss'),function(recv){
            // add data to chart
            var data = {mtgox: {bid: []}, twitter: {sentiment: []}}
            for(var i = 0; i < 24; i++){
              data.mtgox.bid.push(recv.mtgox.bid[i]);
              data.twitter.sentiment.push(recv.tweets.sentiment[i]);
            }

            console.log('mtgox:', data.mtgox.value);
            console.log('twitter:', data.twitter.sentiment);

            // Create the chart
            $('#container').highcharts('StockChart', {
              buttons: [{
                type: 'minute',
                count: 10,
                text: '10min'
              }, {
                type: 'hour',
                count: 1,
                text: '1hr'
              }, {
                type: 'hour',
                count: 3,
                text: '3hr'
              }, {
                type: 'hour',
                count: 12,
                text: '12hr'
              }, {
                type: 'hour',
                count: 24,
                text: '24hr'
              }, {
                type: 'day',
                count: 3,
                text: '3d'
              }, {
                type: 'day',
                count: 7,
                text: '7d'
              }, {
                type: 'day',
                count: 30,
                text: '30d'
              }, {
                type: 'month',
                count: 6,
                text: '6mon'
              }],
              
              credits: {
                enabled: false
              },

              rangeSelector : {
                selected : 1
              },

              title : {
                text : 'MtGox Bid Price'
              },

              series : [{
                name : 'MtGox Bid Price',
                data : data.mtgox.bid,
                type : 'areaspline',
                threshold : null,
                tooltip : {
                  valueDecimals : 2
                },
                fillColor : {
                  linearGradient : {
                    x1: 0, 
                    y1: 0, 
                    x2: 0, 
                    y2: 1
                  },
                  stops : [[0, Highcharts.getOptions().colors[0]], [1, 'rgba(0,0,0,0)']]
                }
              }]
            });
          });
        });
        
        // Apply the theme
        var highchartsOptions = Highcharts.setOptions(Highcharts.theme);
      });
    </script>
  </body>
</html>